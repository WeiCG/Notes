# x86汇编

> 2021-04-25 奔跑的咸鱼

## 寄存器

一切都为了速度

### 通用寄存器

- al(低8位) ah(高8位) ax(16位) eax(32位) rax(64位) - 用处很多，基本没什么固定用途
- bx - 常用于在寻址时存储基地址
- dx - 常用于存放整数除法产生的余数
- cx - 常用于控制循环次数
- di - 在变址寻址的时候会使用
- si - 在变址寻址的时候会使用
- bp - 指向当前栈的底部
- sp - 指向当前栈的顶部

### 段寄存器

- 代码段cs和ip - 程序的代码
- 数据段ds - 在程序中会用到的数据
- 栈段ss - 用来存栈的起始地址
- 额外段es - 备用
- 64位下的fs和gs - 不同的系统有不同的用处

### 标志寄存器

- OF - overflow flag - 溢出标志，加减运算的结果是否溢出
- DF - direction flag - 方向标志
- IF - interrupt enable flag - 屏蔽中断指令
- TF - trap flag - 单步调试，设置后执行一条指令就会被中断
- SF - signal flag - 正负标志位，记录相关指令执行后，结果是否为负
- ZF - zero flag - 零标志位，记录相关结果执行后，结果是否为零
- AF - auxiliary carry flag - 辅助进位标志
- PF - parity flag - 奇偶标志，运算中“1”的个数的奇偶性，偶数为1，奇数为0
- CF - carry flag - 进位标志，如果运算结果的最高位产生了一个进位或错位，其值为1

## 指令

### 运算指令

- 加(add) 减(sub) 乘(mul) 除(div) - 除法的余数会存在dx中
- 与(and) 或(or) 非(not) 异或(xor)
- 左移(shl) 右移(shr)

### 赋值指令

- 立即数寻址 - mov [寄存器], [地址]
- 寄存器寻址 - mov [寄存器1], [寄存器2]
- 基址变址寻址 - mov [bx+di], [寄存器]

### 栈相关指令

- 压栈(push) 弹栈(pop)
- pusha - 将所有通用寄存器中的内容压入栈中
- popa - 将所有通用寄存器中的内容弹出栈

### 跳转指令

- 比较 - cmp [目的操作数] [源操作数] - 使用目的操作数-源操作数来进行比较
- 通常跳转指令以j开头，与cmp连用

### 调用函数

- call - 调用函数
- ret - 函数返回
- retf - 从函数中返回，会更改代码段地址

### 发送中断

- into - 中断溢出指令
- int 8位数 - 可以发送255种中断

### 端口

- in - 从端口读数据
- out - 向端口写数据

## 汇编对比

主要分为Intel汇编和AT&T汇编

|        比较项        |                          Intel风格                           |              AT&T风格               |
| :------------------: | :----------------------------------------------------------: | :---------------------------------: |
|      操作数顺序      |                        目标操作数在前                        |           目标操作数在后            |
|        寄存器        |                           直接使用                           |              添加%前缀              |
|        立即数        |                           直接使用                           |              添加$前缀              |
|      16位进制数      |                    二进制(B)、十六进制(H)                    |              加前缀0x               |
|  访问内存长度的表示  | 前缀BYTE PTR/WORD PTR/DWORD PTR和QWORD PTR表示字节、字、双字和四字 | 后缀b/w/l/q表示字节、字、双字和四字 |
|    全局或静态变量    |                            [var]                             |                 var                 |
| 全局或静态变量的地址 |                             var                              |                $var                 |
|       局部变量       |                          使用栈地址                          |             使用栈地址              |
|       绝对寻址       |                            [imm]                             |                 imm                 |
|       间接寻址       |                            [reg]                             |               (%reg)                |
|     基址相对寻址     |                          [reg+imm]                           |              imm(%reg)              |
|       变址寻址       |                         [base+index]                         |            (base, index)            |

# PE文件解析

## 二进制文件格式

每个平台的二进制文件格式都不相同，Windows平台是PE文件格式；Mac OS使用Mach-o文件格式；Linux使用ELF文件格式

二进制文件分类如下：

- Executable - 包含自己独立执行的代码
  - Windows平台是.exe文件，Linux平台无后缀
- Dynamic Linked Library - 动态链接库，需要被其他文件加载
  - Windows平台的.dll文件；Linux平台是.so文件
- Static Library - 静态链接库
  - Windows平台的.lib文件；Linux平台是.a文件

## 具体内容

- 文件头
- 节区
- 各种属性表 - 包括导入表、导出表和资源表

## 高效学习PE文件

# 静态分析和动态分析

# 加解密算法

# 壳与脱壳