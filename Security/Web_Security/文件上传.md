# 文件上传攻击

## 概述

文件上传是一个非常常见的功能，但如果服务器端不对客户端上传的文件进行严格的验证和过滤，就容易造成可以上传任意文件的情况，包括脚本文件

## WebShell

一种恶意脚本文件，通过执行该脚本文件，攻击者可以控制整个网站甚至是服务器，也被称为一种网页后门

### 小马

也被称为一句话木马，本质是一个只有一句话的脚本、网页或可执行程序

| 常见脚本类型 | 代码                                                         |
| ------------ | ------------------------------------------------------------ |
| PHP          | `<?php @eval($_REQUEST["xxx"]); ?>`                          |
| ASP          | `<%eval request("xxx") %>`                                   |
| ASP.Net      | `<%@ Page Language="Jscript"%> <%eval(Request.Item["xxx"], "unsafe");%>` |

### 大马

代码量和功能比小马多，一般会进行二次编码加密，防止被WAF/IDS识别

### 常见PHP函数

- echo - 返回结果的最后一行，搭配其他函数使用
- 执行函数
  - eval()和各种回调函数 - 执行PHP代码函数
  - system() - 执行系统命令并显示输出
  - passthru() - 执行系统命令并显示原始输出
  - exec() - 执行系统命令，但不输出结果
- 文件操作
  - file_get_contents() - 读入文件内容作为字符串
  - file() - 将整个文件读入一个数组中
  - readfile() - 读取一个文件，并写入到输出缓冲中
  - move_uploaded_file - 将上传的文件移动到新的位置
- 遍历目录
  - scandir() - 返回一个指定目录中的文件和目录的数组
- 包含函数
  - require()和include()
- 特殊函数
  - phpinfo() - 查看PHP信息
  - parse_str() - 变量覆盖

## 攻击方法

### 低安全

不进行任何检测

### 中安全

只在前端进行检测，使用JS可以对文件的扩展名进行检测，Content-Type也可以进行判断文件类型，

但通过BurpSuite拦截并对请求进行修改，可以继续上传

### 高安全

在中安全的基础上，在后端也进行检测

- 尝试使用图片木马搭配文件包含漏洞一起执行
- 配合Web服务器的后缀解析漏洞来绕过检测
  - Apache服务器是从右向左解析文件后缀的，如果最右侧的后缀不可识别，就继续向左判断，直到遇到可解析的后缀为止

### 最终安全

在高安全的基础上，部署WAF以及经常对代码进行审计

## 防御手段

- 使用白名单的方式判断文件后缀是否合法
- 对上传后的文件进行重命名