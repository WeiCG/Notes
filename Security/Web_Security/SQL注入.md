> 2020年11月12日 奔跑的咸鱼

# 概述

定义：SQL注入是服务端未严格校验客户端发送的数据，而导致服务端SQL语句被恶意修改并成功执行的行为

情景

1. 参数用户可控 - 前端传给后端的参数内容是用户可以控制的
2. 参数带入数据库查询 - 传入的参数拼接到SQL语句，且带入数据库查询

适用场景：所有涉及到与数据库交互的情景都可能发生SQL注入

解决方法：凡外部输入皆不可信

## 分类

- 按注入数据的来源分类
  - GET注入 - SQL语句需要URL中的参数来构建
  - POST注入 - SQL语句需要网页中的部分用户输入来构建
  - HTTP头 - SQL语句需要获取Cookie或User-Agent等HTTP协议头来辅助，因此通过修改HTTP协议头来进行注入
  - JSON类型 - SQL语句需要获取前端传输的JSON格式的数据来构建
  
- 按注入数据的类型分类
  - 整型注入 - 要输入的数据是整型的
  - 字符型注入 - 要输入的数据是字符型的，因此必须要闭合字符串才行。闭合的东西包括单引号、双引号和括号
  

# 步骤

1. 是否对用户输入进行了严格校验，即是否存在注入点

   - 可控参数的不同输入能否影响页面的改变，类似输入`id = 1 and 1 = 1`和`id = 1 and 1 = 2`时，页面一个正常一个错误

   - 输入的SQL语句是否能报错，即根据显示的数据库错误信息来查看数据库语句的一些痕迹
   - 输入的SQL语句是否能不报错
2. 判断是什么类型的注入
3. 语句是否可以被恶意修改
4. 修改后语句是否可以被成功执行

# 攻击方式

## 概述

不论是什么样的注入方式，都需要获取信息：

- 操作系统、数据库用户和数据库版本
- 所在数据库名、其中的表名和字段名
- 数据库中的具体数据
  - 如果无法获得高权限，则只能够进行常规的数据查询
  - 如果有高权限的话，除数据查询外，还可以**执行命令**和**文件读写**

大部分数据库的注入流程都是一样的，唯一的区别只在于语句的不同，下面的所有攻击方式全部都以MySQL数据库为例

## Union注入

当数据库中有数据返回时，可以通过构建Union注入的手段来使得SQL语句返回数据库中的内容

1. 首先通过`order by`语句来测试select语句中的查询字段数
2. 配合Union语句来确定select语句中输出的是什么位置的查询字段数
3. 使用Union语句来查询相关的数据库、表和字段信息
4. 通过查询到的数据库、表和字段信息来查询具体的数据
   - 使用limit语法依次获取多行数据
   - 使用group_concat()函数显示全部列数据

## Boolean注入

页面会根据数据库中查询出的不同内容显示不同的结果，因此需要构造SQL判断语句，通过查看不同的页面返回结果来推测哪些SQL语句判断条件是成立的

1. 使用`length()`函数与数字进行比较获得要获取名称的长度
2. 在得到长度的前提下，通过`substr()`函数来不断与字母相比较获得实际的名称
3. 不断重复1和2步骤知道获得所有要获取的数据为止

## 文件读写攻击

文件读写攻击通常需要获取数据库的高权限，并且数据库需要打开文件读写功能才可以实行

|            重要函数            | 作用     |
| :----------------------------: | -------- |
|       select load_file()       | 读取文件 |
| select 内容 into outfile 文件  | 文件导出 |
| select 内容 into dumpfile 文件 | 文件导出 |

### 路径获取方法

- 报错显示
- 遗留文件
- 漏洞报错
- 平台配置文件
- 爆破

# 常见数据库

## Access

- 通常是搭配ASP使用，在国内基本没有商业使用的环境，仅限于自己的测试
- Access数据库与其他数据库相比，极其轻量级，Access数据库与其他数据库下的`database`是同一级别的，它本身无法创建`schema`，所有的表都存储于一个`schema`下，因此Access数据库中不存在跨库查询，也不需要获取数据库名
- Access数据库的所有表的内容全部都在网站源码中
- Access数据库没有文件读写的功能，因此高权限也没有什么意义

### 信息获取

- Access数据库的功能极其有限，不能获取操作系统、数据库用户和数据库版本(没有那些功能)
- 也不能获取数据库名，因此直接查询表、字段和数据即可

### 表和字段查询

- 只能使用暴力和猜测的方式来获取
- 如果表名和字段名暴力和猜测不到，

## MSSQL

直接百度查询注入即可，慢慢的逐步添加内容

## MySQL

MySQL 5.0之后的数据库、表和字段信息都存储在information_schema数据库中；而之前只能使用暴力查询或联合读取查询

|    表    | 字段                                  | 描述                                           |
| :------: | :------------------------------------ | ---------------------------------------------- |
| schemata | schema_name                           | 对应用户创建的数据库的库名                     |
|  tables  | table_schema、table_name              | 对应用户创建的数据库的库名和其中的表名         |
| columns  | table_schema、table_name、column_name | 对应用户创建的数据库的库名和其中的表名、字段名 |

### 常用函数

|        函数名        | 描述                                                         |
| :------------------: | ------------------------------------------------------------ |
| @@version_compile_os | 查看当前操作系统                                             |
|        user()        | 查看当前登陆用户                                             |
|      version()       | 查看当前MySQL的版本                                          |
|      database()      | 当前所在数据库                                               |
|     concat_ws()      | 拼接字段返回字符串。参数1是分隔符，后面的参数是要拼接的字段  |
|       substr()       | 获取子字符串                                                 |
|    group_concat()    | 将指定列的所有值拼接为一个字符串返回，用于一次查询指定列的所有返回结果 |
