# 密码学基础

## 密码学发展历史

### 古典密码

从古代到19世纪末

古典密码体制的安全性在于保持算法本身的保密性，受到算法限制

- 不适合大规模生产
- 不适合较大的或者人员变动较大的组织
- 用户无法了解算法的安全性

#### 主要分类

- 代替密码（Substitution Cipher)
- 换位密码（Transposition Cipher)
- 代替密码与换位密码的组合

#### 举例

- 象形文字
- 隐写术
- 塞塔式 - 用木棍辅助在纸条下写下内容，抽出木条后就是密文
- 凯撒密码 - 单表系统密码，容易被破解
  - 字母频率分析法
- 多表加密系统 - 通过引入其他的维数（如：字母出现在单词中的位数）来使用不同的密码表

### 近代密码

从20世纪初到1949年 - 两次世界大战的推动

主要标志是**机械密码/机电密码**，用机工代替手工，出现了轮转机，其中最著名的便是二战中德军使用的ENIGMA

与古典密码没有什么本质进步，只是用机械代替了手工使得计算能力大幅度提高

#### 一次一密

理论上不可攻破的密码

- 不重复使用乱码本，所以密码表只使用一次
- 使用不可预知的随机数（一般来自物理源，如放射线衰减）

但有个问题，如何传递密码本？

### 现代密码

从C.E.Shannon(香农)于1949年发表的划时代论文“The Communication Theory of Secret Systems”开始

密码学开始进化，出现了新特点：**数据的安全基于密钥而不是算法的保密**

### 公钥密码

从1976年W.Diffie和M.Hellman创造性地发表了论文“New Directions in Cryptography”开始

公钥密码使得发送端和接收端无密钥传输的保密通信成为可能

## 密码学基本概念

密码学是研究信息系统安全保密的科学。由两个相互独立、相互争斗，而又相辅相成、相互促进的分支科学所组成，分为密码编码学和密码分析学。

### 密码相关术语

- 加密 - 将明文变换为密文的过程，把人类可懂的语言变换为人类不可懂的语言
- 解密 - 加密的逆过程，即由密文恢复成原明文的过程，把人类不可懂的语言变换为人类可懂的语言
- 密钥 - 加密和解密通常是在一组密钥的控制下进行的，分别称为加密密钥和解密密钥
- 密钥空间 - 用于加密的密钥的比特序列长度
  - 密钥是由密钥空间的随机值构成，密钥空间越大，密钥被攻破的难度就越大
- 密钥管理 - 处理密钥自产生到最终销毁的整个过程中的相关问题，包括系统的初始化、密钥的产生、存储、备份/恢复、装入、分配、保护、更新、泄露、撤销和销毁等
- 扩散 - 将每一位明文数字的影响尽可能地散步到多个输出密文数字中去，以更隐蔽明文数字的统计特性
- 混乱 - 使得密文的统计特性与明文、密钥之间的关系尽量复杂化

### 密码分析方式

- 唯密文攻击 - 攻击者知道一些消息的密文，并试图恢复出其所对应的的明文，并进一步试图推算出加密消息的密钥
- 已知明文攻击 - 攻击者不仅知道一些消息的密文，也知道这些密文对应的明文，并试图推导出加密密钥或算法
- 选择明文攻击 - 在已知明文攻击的基础上，攻击者还可以自己选择被加密的明文，并试图推导出加密密钥或算法
- 选择密文攻击 - 攻击者能够选择不同的密文并能得到对应的明文，并试图推导出加密密钥或算法
- 旁路攻击 - 通过搜集“外面”的信息来破解密码，而不是直接处理“里面”的东西
- 重放攻击 - 攻击者捕获了一些类型的数据并重新提交它，寄希望于欺骗接受设备误以为这些是合法信息
- 统计式攻击 - 利用明文的已知统计规律进行破译的方法。攻击者对截获的密文进行统计分析，总结出其统计规律，并与明文的统计规律进行对照比较，从中提取出明文和密文直接的对应或变换信息

### 密码体制分类

- 受限制的算法 VS 基于密钥的算法
  - 前者是算法的保密性基于保持算法的秘密
  - 后者是算法的保密性基于对密钥的保密
- 对称密码 VS 非对称密码
  - 前者的加密密钥和解密密钥相同，或实质上等同（从一个易于推出另一个）
  - 后者的加密密钥和解密密钥不同，从一个很难推出另一个
- 分组密码 VS 流密码（序列密码）
  - 前者将明文分成固定长度的组，用同一个密钥和算法对每一块加密，输出也是固定长度的密文
  - 后者每次加密一位或一字节的明文
- 代替密码 VS 置换密码
  - 前者就是将明文中的每一个字符被替换为密文中的另一个字符。接收者对密文做反向替换就可以恢复出明文
  - 后者则是明文中的字母保持相同，但顺序被打乱了

### 密钥管理

在一种安全策略指导下，密钥的产生、存储、分配、删除、归档及应用

所有的密码技术都依赖于密钥，这是一个很复杂的课题而且是保证安全性的关键点

- 密钥的生存周期
  - 所有密钥都有生存周期，包括：产生、分配、使用、更新/替换、撤销、销毁
  - 拥有大量的密文有助于密码分析，而一个密钥使用得太多会给攻击者增大搜集密文的机会
- 密钥的产生
- 密钥的分配
  - 无中心的密钥分配模式
  - 中心化密钥分配模式
  - 公钥密钥体制的密钥分配 - 最常用
- 密钥管理的其他阶段
  - 密钥使用
  - 密钥存储 - 现更多的存储在USB Key中
  - 密钥更新 - 最容易的解决方法是从旧密钥中产生新密钥；公私钥对重新生成
  - 密钥备份 - 可信第三方托管或使用主密钥或公钥加密保存，主要针对加密密钥
  - 密钥销毁 - 物理上彻底粉碎

## 对称密码算法

#### 特点

- 加密密钥和解密密钥相同，或实质上等同
- 优点 - 高效，算法简单，系统开销小；适合加密大量数据；明文长度与密文长度相等
- 缺点 - 安全交换密钥问题及密钥管理复杂

#### 典型算法

DES（应用最广泛）、3DES、AES（未来最广泛）、IDEA（欧洲较多）、RC5、Twofish、CAST-256、MARS

#### DES（数据加密标准）

1973年立项；1976年11月23日确定为联邦标准；1983年ISO将其作为国际标准；1998年不再作为联邦标准

- 密钥长度为56bit（加上奇偶校验，通常写成64bit）
- 分组加密算法，64bit为一个分组
- 基本思想为混乱和扩散
- 使用标准的算法运输和逻辑运输

#### AES（高级数据加密标准）

1997年4月15日立项；2000年10月2日，NIST宣布获胜者为Rijndael算法；2002年5月正式生效

- 非保密的、可以公开技术细节的、全球免费使用的分组密码算法
- 比3DES快、至少与3DES一样安全、数据分组长度为128bit、密钥长度为128/192/256bit

## 公钥密码算法

#### 特点

- 加密和解密由两个不同的密钥完成
  - 拥有公钥和私钥两个密钥
  - 知道加密算法，从加密密钥得到解密密钥在计算上时不可行的
  - 两个密钥中任何一个都可以用作加密密钥而另一个用作解密
- 优点 - 解决密钥传递问题；密钥管理简单；提供了数字签名等其他服务
- 缺点 - 计算复杂、耗用资源大；非对称导致得到的密文变长

#### 单向陷门函数

- 给定x，计算y=f(x)是容易的
- 给定y，计算x使y=f(x)是困难的
- 存在z，已知z时，对给定的任意y，若相应的x存在，则计算x使y=f(x)是容易的

#### Diffie-Hellman算法

- 第一个发表的公开密钥算法 - 1976年
- 用于通信双方安全地协商一个会话密钥，只能用于密钥交换
- 数学基础 - 有限域内计算离散对数的困难性为基础
- 主要是模幂运算 - a^p^ mod n

#### RSA算法

- 1977年提出，1978年正式公布
- 目前应用最广泛的公钥密码算法
- 数学基础 - 初等数论中的Euler定理，并建立在分解大整数因子的困难性之上

## 散列函数

散列函数也叫哈希函数，将任意长度的消息映射成一个较短的定长输出报文的函数

- 作用 - 完整性校验
- 主要算法 - MD5、SHA系列
- 数学性质 - 单向性；弱抗碰撞性；强抗碰撞性

### 特点

- 能够应用到任意长度的数据上
- 能够生成大小固定的输出
- 对于任意给定的x，H(x)的计算相对简单
- 对于给定的散列值h，要发现满足H(x)=h的x在**计算上**是不可行的
- 对于给定的消息x，要发现另一个消息y满足H(x)=H(y)在**计算上**是不可行的

### MD5算法

- 输入 - 任意长度的消息
- 输出 - 128bit的消息摘要
- 处理 - 以512bit输入数据块为单位

### SHA-1算法

- 输入 - 最大长度为2^64^bit的消息
- 输出 - 160bit的消息摘要
- 处理 - 以512bit输入数据块为单位

## 消息鉴别

对收到的消息进行验证，证明确实是来自声称的发送方，并且没有被修改过

- 作用 - 完整性校验、时间和顺序验证

### 认证方式

- 消息加密
- 哈希函数
- 消息认证码（MAC）

## 数字签名

基于哈希函数、公钥密码体系所综合的技术，通过附加在数据单元上的一些数据，或对数据单元所做的密码变换，这种数据或变换能使数据单元的接收者确认数据单元来源和数据单元的完整性，并保护数据，防止被人伪造

### 作用

- 不可伪造性
- 不可否认性
- 保证消息完整性

### 基本条件

- 签名者并不能否认自己的签名
- 接收者能够验证签名，而其他任何人都不能伪造签名
- 当关于签名的真伪发生争执时，存在一个仲裁机构或第三方能够解决争执

## PKI体系

PKI指公钥基础设施，其中心为认证中心（CA）

- 利用公钥技术建立的提供信息安全服务的在线基础设施，利用加密、数字签名、数字证书来保护应用、通信或事务处理的安全
- 是一组建立在公钥技术基础上的硬件、软件、人员和应用程序的集合，它具备生产、管理、存储、核发和废止证书的能力，从运营、管理、规范、法律、人员等多个角度来解决网络信任问题
- 是一种遵循标准、利用公钥加密技术提供安全基础平台的技术和规范，是能够为网络应用提供信任、加密以及密码服务的一种基本解决方案

PKI的本质是针对数字签名中进行公钥验证时，验证者无法得知获取的公钥是否是对应用户的公钥，而通过可信第三方就可以

### 数字证书

是一段电子数据，是经证书认证机构CA签名的、包含拥有者身份信息和公开密钥的数据体

数字证书格式 - X.509标准

生命周期包括：申请、生成、存储、发布、废止

基本内容至少要包含：

- 颁发机构 - 即CA是谁
- 证书持有者的名字
- 证书持有者的公钥
- 证书有效期
- 证书颁发机构的签名

### 四类实体

- 认证机构CA - 负责证书的发放
  - 签发数字证书 - 颁发、更新
  - 管理数字证书 - 撤销、查询、审计、统计
  - 验证数字证书 - 证书撤销认证（CRL）、在线认证（OCSP）
- 注册机构RA - 负责证书的申请和审核
  - 受理用户的数字证书申请 - 审核证书申请者的身份并提交给CA
  - 提供证书生命周期的维护工作
- 证书存放管理 - 目录服务
  - 即证书的保持、修改、删除和获取的能力
  - 采用LDAP目录访问协议，对于访问的效率要比传统数据库高
  - 证书撤销列表CRL - 列出被撤销的证书序列号（在证书有效期内，由于各种原因导致证书不再可信）
- 证书持有者和应用程序

## VPN技术

### 分类

- 按协议层次 - 二层VPN、三层VPN、四层VPN和应用层VPN
- 按应用范围 - 远程访问VPN、内联网VPN和外联网VPN
- 按体系结构 - 网关到网关VPN、主机到网关VPN和主机到主机VPN

### 工作原理及关键技术

- 隧道技术 - VPN的本质就是搭建了一条隧道，然后将各种数据包在该隧道中传输
  - 不同隧道的根本区别就在于用户在隧道中传输的数据包是被封装在哪种数据包中
  - 隧道技术按期拓扑结构分为点对点隧道和点对多隧道，而VPN主要采用点对点隧道
  - 目前存在多种VPN隧道协议
    - 链路层隧道协议（二层隧道协议），包括L2TP、PPTP、L2F等
    - IPsec协议体系
    - MPLS、SSL
- 加解密技术
- 密钥管理技术
- 使用者与设备身份认证技术
- 访问控制技术

### IPsec协议体系

IPsec协议由封装协议和密钥管理协议组成

#### 封装协议

定义了IPsec数据包的封装结构以及加密和认证结构，包括ESP和AH两种协议。对于不同的VPN结构，IPsec提供了两种模式的封装：Tunnel和Transport

AH协议和ESP协议同使用50作为协议号

|            |                            AH协议                            |                           ESP协议                            |
| :--------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|  提供功能  |         数据来源认证、数据完整性校验、防报文回放攻击         |               除AH的功能外，还提供了机密性保证               |
|  隧道模式  | 为每个包创建一个新的IP报头<br />完整性校验包括新IP报头、AH报头、原IP报头、传输层报头和应用数据 | 为每个包创建一个新的IP报头<br />完整性校验包括ESP报头、原IP报头、传输层报头、应用数据和ESP报尾<br />加密部分包括原IP报头、传输层报头、应用数据和ESP报尾 |
|  传输模式  | 不需要创建新的IP报头<br />完整性校验包括IP报头、AH报头、传输层报头和应用数据 | 不需要创建新的IP报头<br />完整性校验包括ESP报头、传输层报头、应用数据和ESP报尾<br />加密部分包括传输层报头、应用数据和ESP报尾 |
| 完整性校验 |                 完整性校验的签名位于AH报头中                 |       完整性校验的签名位于ESP认证报尾处，位于包的最后        |

#### 安全关联 - SA

构成IPsec的基础，是两个通信实体经协商建立起来的一种协定，包括

- 用来保护数据包安全的IPsec协议，如：ESP或AH协议、隧道模式或传输模式
- 转码方式，如：哈希算法的选择、加密算法的选择等
- 密钥及密钥的有效存在时间

任何IPsec实施方案都需要构建一个SA数据库，由它来维护IPsec协议用来保障数据包安全的SA记录

SA的创建可以由手工配置完成，但较为麻烦且容易出错，因此通常都是使用某些协议来自动协商完成

#### 密钥管理协议 - IKE

IKE能够自动的实现密钥的交换，简化了手工配置的复杂性。同时也解决了IPsec难以扩展的特性

- 协商SA的安全特性
  - ISAKMP协议：定义了协商、建立、修改和删除SA的过程和包格式，但其只是一个框架，没有定义具体的SA格式
- 密钥的自动生成
- 易于管理和配置

IKE阶段

- 阶段一 - 认证对等体、协商安全关联

- IKE阶段二 - 协商IPsec SAs/SPIs

- IKE阶段一会交换生成一个共享密钥，用于阶段二的数据加密使用

### SSL协议

位于TCP层之上、应用层之下，为上层应用在网络间建立一条安全通道

提供：服务器认证、客户认证（可选）、链路上的数据完整性和数据保密性等保护功能

SSL协议共包括四种协议

- SSL记录协议 - 所有的传输数据都被封装在记录中，提供机密性和完整性两种服务
  - 记录协议包括记录头和记录数据格式
  - 机密性使用了对称加密算法；完整性使用了HMAC算法
- SSL握手协议 - 在双方通信时进行身份认证、协商加密和MAC算法以及用来保护在SSL记录中发送数据的加密应用，在传输任何数据前，都必须使用握手协议
  - 鉴别、协商加密算法和密钥
  - 提供了连接安全性
- SSL更改密码说明协议
- SSL警告协议

SSL协议的安全性

- 对于每个连接都有唯一的会话密钥；采用对称密钥加密会话数据
- 采用HMAC算法保障数据完整性
- 使用非对称算法，支持使用数据证书鉴别；支持单向、双向鉴别

# 网络协议安全

## 网络协议分层

### OSI七层模型

#### 物理层

- 定义了物理链路的电气、机械、通信规程、功能要求等
- 将比特流转换成电压
- 主要设备包括：光纤、双绞线、中继器、集线器等
- 常见标准有：100BaseT、OC-3、OC-12、DS1、DS3、E1、E3等

#### 数据链路层

- 物理寻址、网络拓扑、线路规章等；错误检测和通告（但不纠错）；将比特聚成帧进行传输；流量控制（可选）
- 寻找机制：使用数据接收设备的硬件地址（物理地址）寻址
- 主要设备包括：网卡、网桥、交换机
- 常见协议有：PPP、HDLC、FR、Ethernet、Token Ring、FDDI等

#### 网络层

- 逻辑寻址、路径选择
- 寻址机制：使用网络层地址（IP地址）进行寻址
- 主要设备：路由器、三层交换机

#### 传输层

- 提供端到端的数据传输服务；建立逻辑连接
- 寻址机制：应用程序的界面端口（如端口号）
- 常见协议有：TCP、UDP、SPX等

#### 会话层

- 不同应用程序的数据隔离；会话建立、维持、终止；同步服务；会话控制（单向或双向）

#### 表示层

- 数据格式表示；协议转换；字符转换；数据加密/解密；数据压缩等
- 主要数据格式：ASCII、MPEG、TIFF、GIF、JPEG等

#### 应用层

- 应用接口；网络访问流处理；流控；错误恢复
- 主要协议：FTP、Telnet、HTTP、SNMP、SMTP、DNS等

### 分层结构的优点

- 降低复杂性
- 促进标准化工作
- 各层间相互独立，某一层的变化不会影响其他层
- 协议开发模块化
- 简化理解与学习

### 数据封装与分用

- 封装 - 应用数据发送时从高层到低层逐层加工后传递
- 解封装 - 数据接收时从低层到高层逐层传递

### TCP/IP协议模型

TCP/IP协议共存在四层模型

- 应用层 - 对应OSI的应用层、表示层、会话层
  - 多个应用协议
- 传输层 - 对应OSI的传输层
  - TCP、UDP
- 网络互联层（或网际层）- 对应OSI的网络层
  - ICMP、IP、IGMP
- 网络接口层 - 对应OSI的数据链路层、物理层
  - ARP、硬件接口、RARP

